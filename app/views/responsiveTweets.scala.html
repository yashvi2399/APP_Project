@(webJarsUtil: org.webjars.play.WebJarsUtil)

    @main("ResponsiveTweetSearch") {
    
        <div class="container">
            <div class="input-group mt-3 mb-3">
                <input id="searchKeyPhrase" type="text"
                class="form-control border border-success"
                placeholder="Enter a Key word phrase (ex. Content Writer)"
                aria-describedby="basic-addon2"
                autofocus>
                <div class="input-group-append">
                    <button id="send" class="btn btn-outline-success" type="submit">Send</button>
                </div>
            </div>
        </div>

        <div class="container" id="messages">
                <!-- This container would be filled by script below -->
        </div>

        @Html(webJarsUtil.script("jquery.min.js"))

        <script language="javascript">
                console.log('JS Beginning');
                var text = "";
                var $messages = $("#messages"),
                        $send = $("#send"),
                        $searchKeyPhrase = $("#searchKeyPhrase"),
                        connection = new WebSocket("@routes.ResponsiveApplicationController.websocket().webSocketURL()"),
                        userProfileUrl = "@routes.ApplicationController.userProfile("").url";
                console.log('JS after var');

                $send.prop("disabled", true);

                var send = function () {
                    text = $searchKeyPhrase.val();
                    $searchKeyPhrase.val("");
                    // console.log('sent', text);
                    // console.log('sent as Json ', JSON.stringify({searchKey: text}));
                    var search = {
                        searchKey : ''
                    };
                    search.searchKey = text;
                    connection.send(JSON.stringify(search));
                };

                connection.onopen = function () {
                    $send.prop("disabled", false);
                    $send.on('click', send);
                    $searchKeyPhrase.keypress(function (event) {
                        var keycode = (event.keyCode ? event.keyCode : event.which);
                        if (keycode == '13') {
                            send();
                        }
                    });
                };

                connection.onerror = function (error) {
                    console.log('WebSocket Error ', error);
                };

                connection.onmessage = function (event) {
                    var keyPhraseAndTweets = JSON.parse(event.data);
                    //console.log(Object.keys(keyPhraseAndTweets).length);

                    var show = "show";
                    if (Object.keys(keyPhraseAndTweets).length > 1) {
                        show = "";
                    }
                    for (var keyPhrase in keyPhraseAndTweets) {
                        var keyPhraseId = keyPhrase.split(' ').join('-');
                        console.log("keyPhraseId="+keyPhraseId);
                        toAppend ='';
                        if (document.getElementById(keyPhraseId) == null) {
                            console.log("getElementById(keyPhraseId) == null");
                            var toAppend = "<hr>";
                                toAppend += "<ul id='" + keyPhraseId + "' class='list-unstyled'>";
                                    toAppend += composeTweets(keyPhraseAndTweets[keyPhrase]);
                                toAppend += "</ul>";
                            $messages.prepend($(toAppend));
                        } else {
                            document.getElementById(keyPhraseId).innerHTML = composeTweets(keyPhraseAndTweets[keyPhrase]);
                        }
                    }
                    function composeTweets(tweetsForKeyPhrase) {
                        toAppend += "<h5> Search results for: " + keyPhrase + "</h5>";
                        var link3 = "http://localhost:9000/globalstats/" +text ;
  						toAppend += "<td>  &nbsp | &nbsp <a href=\"" +  link3 + "\"> Global Stats </a> &nbsp  </td>";
  						var link4 = "http://localhost:9000/globalflesch/" +text ;
  						toAppend += "<td>  &nbsp | &nbsp <a href=\"" +  link4 + "\"> Global Readability </a> &nbsp  </td>";
  						
                        for (var el in tweetsForKeyPhrase) {
                            //console.log("getElementById(keyPhraseId) == found the element");
                            
                           toAppend += "<div class=\"row \">";
                                        toAppend += "<li class=\"media bg-light border border-primary rounded p-3 mt-3 mb-3\">";
                                        toAppend += "<table>";
                                        toAppend += "<tr>";
                                            toAppend += "<td> &nbsp <a target='_blank' href=\"" + userProfileUrl + keyPhraseAndTweets[keyPhrase][el].owner_id + "\" class=\"btn btn-link\" role=\"button\">" + keyPhraseAndTweets[keyPhrase][el].owner_id + "</a> &nbsp </td>";
                                            toAppend += "<td> &nbsp" + keyPhraseAndTweets[keyPhrase][el].time_submitted + "&nbsp </td>";
                                            toAppend += "<td> &nbsp" + keyPhraseAndTweets[keyPhrase][el].title + "&nbsp </td>";
                                            toAppend += "<td> &nbsp Type:" + keyPhraseAndTweets[keyPhrase][el].type + "&nbsp </td>";
                                            toAppend += "<td>  &nbsp  Skills: </td>";
                                            
                                            for(var skill in keyPhraseAndTweets[keyPhrase][el].jobs) {
                                            	var skillname = keyPhraseAndTweets[keyPhrase][el].jobs[skill].name;
                                            	toAppend += "<td> &nbsp <a href=\" http://localhost:9000/skills/" +skillname+ "\">" + skillname + " </a> &nbsp </td>";
                                            }
                                            
                                            var link = "http://localhost:9000/stats/" +text+ "/" + keyPhraseAndTweets[keyPhrase][el].title;
  											toAppend += "<td>  &nbsp | &nbsp <a href=\"" +  link + "\"> Stats </a> &nbsp  </td>";
  											
  											var link2 = "http://localhost:9000/flesch/" +text+ "/" + keyPhraseAndTweets[keyPhrase][el].title;
  											toAppend += "<td>  &nbsp | &nbsp <a href=\"" +  link2 + "\"> Readability  &nbsp  </td>";
  											
                                        toAppend += "</tr>"
                                        toAppend += "</table>";
                                        toAppend += "</li>";
                                        
                            toAppend += "</div>";
                                
                        }
                        return toAppend;
                    }
                }
        </script>
    }